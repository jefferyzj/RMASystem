{% extends "base.html" %}

{% block title %}Feature Manage{% endblock %}

{% block extra_head %}
<script>
    function toggleFormSections() {
        const selectedAction = document.querySelector('input[name="action"]:checked').value;
        document.querySelectorAll('.form-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(`${selectedAction}-form-section`).style.display = 'block';
    }

    function toggleCategoryAction() {
        const selectedCategoryAction = document.querySelector('input[name="category_action"]:checked').value;
        document.querySelectorAll('.category-action-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(`${selectedCategoryAction}-category-section`).style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const actionRadios = document.querySelectorAll('input[name="action"]');
        actionRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                this.form.submit();
            });
        });

        const categoryActionRadios = document.querySelectorAll('input[name="category_action"]');
        categoryActionRadios.forEach(radio => {
            radio.addEventListener('change', toggleCategoryAction);
        });

        // Trigger change event on page load to set initial visibility
        toggleFormSections();
        toggleCategoryAction();
    });
</script>
{% endblock %}

{% block content %}
<h1>Feature Manage</h1>
<form method="get">
    <label><input type="radio" name="action" value="category" {% if selected_action == 'category' %}checked{% endif %}> Manage Categories</label>
    <label><input type="radio" name="action" value="status" {% if selected_action == 'status' %}checked{% endif %}> Manage Statuses</label>
    <label><input type="radio" name="action" value="task" {% if selected_action == 'task' %}checked{% endif %}> Manage Tasks</label>
    <label><input type="radio" name="action" value="location" {% if selected_action == 'location' %}checked{% endif %}> Manage Locations</label>
</form>

<form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="{{ selected_action }}">

    <div id="category-form-section" class="form-section">
        <label><input type="radio" name="category_action" value="add" checked> Add Category</label>
        <label><input type="radio" name="category_action" value="delete"> Delete Category</label>

        <div id="add-category-section" class="category-action-section">
            <h3>Add Category</h3>
            {{ category_form.name.label_tag }} {{ category_form.name }}
        </div>

        <div id="delete-category-section" class="category-action-section" style="display: none;">
            <h3>Delete Category</h3>
            {% if categories_exist %}
                {{ category_form.category.label_tag }} {{ category_form.category }}
                <p id="category-product-count"></p>
            {% else %}
                <p>No categories available for deletion.</p>
            {% endif %}
        </div>
    </div>

    <div id="status-form-section" class="form-section">
        {{ formsets.status.management_form }}
        <table>
            {% for form in formsets.status %}
                <tr>
                    <td>{{ form.name.label_tag }} {{ form.name }}</td>
                    <td>{{ form.description.label_tag }} {{ form.description }}</td>
                    <td>{{ form.DELETE }}</td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <div id="task-form-section" class="form-section">
        {{ formsets.task.management_form }}
        <table>
            {% for form in formsets.task %}
                <tr>
                    <td>{{ form.action.label_tag }} {{ form.action }}</td>
                    <td>{{ form.description.label_tag }} {{ form.description }}</td>
                    <td>{{ form.status.label_tag }} {{ form.status }}</td>
                    <td>{{ form.is_predefined.label_tag }} {{ form.is_predefined }}</td>
                    <td class="hidden">{{ form.order.label_tag }} {{ form.order }}</td>
                    <td>{{ form.DELETE }}</td>
                </tr>
            {% endfor %}
        </table>
        <div id="predefined-tasks-container"></div>
    </div>

    <div id="location-form-section" class="form-section">
        {{ formsets.location.management_form }}
        <table>
            {% for form in formsets.location %}
                <tr>
                    <td>{{ form.action.label_tag }} {{ form.action }}</td>
                    <td>{{ form.rack_name.label_tag }} {{ form.rack_name }}</td>
                    <td>{{ form.layer_number.label_tag }} {{ form.layer_number }}</td>
                    <td>{{ form.num_spaces_per_layer.label_tag }} {{ form.num_spaces_per_layer }}</td>
                    <td>{{ form.remove_layer_number.label_tag }} {{ form.remove_layer_number }}</td>
                    <td>{{ form.remove_rack_name.label_tag }} {{ form.remove_rack_name }}</td>
                    <td>{{ form.DELETE }}</td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <button type="submit">Save</button>
</form>
{% endblock %}