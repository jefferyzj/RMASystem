{% extends "base.html" %}

{% block title %}Feature Manage{% endblock %}

{% block extra_head %}
<script>
    function toggleFormSections() {
        const selectedAction = document.querySelector('input[name="form_action"]:checked');
        if (selectedAction) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`${selectedAction.value}-form-section`).style.display = 'block';
        }
    }

    function toggleCategoryAction() {
        const selectedCategoryAction = document.querySelector('input[name="category_action"]:checked');
        if (selectedCategoryAction) {
            document.querySelectorAll('.category-action-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`${selectedCategoryAction.value}-category-section`).style.display = 'block';
        }
    }

    function toggleTaskAction() {
        const selectedTaskAction = document.querySelector('input[name="task_action"]:checked');
        if (selectedTaskAction) {
            document.querySelectorAll('.task-action-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`${selectedTaskAction.value}-task-section`).style.display = 'block';
        }
    }

    function toggleOrderField() {
        const isPredefined = document.querySelector('input[name="is_predefined"]');
        const orderField = document.getElementById('order-field');
        const predefinedTasksList = document.getElementById('predefined-tasks-list');
        const predefinedTasksDescription = document.getElementById('predefined-tasks-description');
        const statusSelect = document.querySelector('select[name="status"]');
        if (isPredefined && orderField && predefinedTasksList && predefinedTasksDescription && statusSelect) {
            if (isPredefined.checked && statusSelect.value) {
                orderField.style.display = 'block';
                predefinedTasksDescription.style.display = 'block';
                statusSelect.setAttribute('required', 'required');
                listPredefinedTasks(statusSelect.value);
                updateOrderChoices(statusSelect.value);
            } else {
                orderField.style.display = 'none';
                predefinedTasksList.innerHTML = '';
                predefinedTasksDescription.style.display = 'none';
                statusSelect.removeAttribute('required');
            }
        }
    }

    function listPredefinedTasks(statusId) {
        fetch(`/get_predefined_tasks/?status_id=${statusId}`)
            .then(response => response.json())
            .then(data => {
                const predefinedTasksList = document.getElementById('predefined-tasks-list');
                predefinedTasksList.innerHTML = '';
                data.tasks.forEach(task => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `Task: ${task['task__task_name']}, Order: ${task.order}`;
                    predefinedTasksList.appendChild(listItem);
                });
            })
            .catch(error => console.error('Error fetching predefined tasks:', error));
    }

    function updateOrderChoices(statusId) {
        fetch(`/get_order_choices/?status_id=${statusId}`)
            .then(response => response.json())
            .then(data => {
                const orderField = document.querySelector('select[name="order"]');
                orderField.innerHTML = '';
                data.choices.forEach(choice => {
                    const option = document.createElement('option');
                    option.value = choice.value;
                    option.textContent = choice.display;
                    orderField.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching order choices:', error));
    }

    document.addEventListener('DOMContentLoaded', function() {
        const actionRadios = document.querySelectorAll('input[name="form_action"]');
        actionRadios.forEach(radio => {
            radio.addEventListener('change', toggleFormSections);
        });

        const categoryActionRadios = document.querySelectorAll('input[name="category_action"]');
        categoryActionRadios.forEach(radio => {
            radio.addEventListener('change', toggleCategoryAction);
        });

        const taskActionRadios = document.querySelectorAll('input[name="task_action"]');
        taskActionRadios.forEach(radio => {
            radio.addEventListener('change', toggleTaskAction);
        });

        const isPredefinedCheckbox = document.querySelector('input[name="is_predefined"]');
        if (isPredefinedCheckbox) {
            isPredefinedCheckbox.addEventListener('change', toggleOrderField);
        }

        const statusSelect = document.querySelector('select[name="status"]');
        if (statusSelect) {
            statusSelect.addEventListener('change', toggleOrderField);
        }

        // Trigger change event on page load to set initial visibility
        toggleFormSections();
        toggleCategoryAction();
        toggleTaskAction();
        toggleOrderField();

        // Display messages and handle redirection
        const messageContainer = document.querySelector('.messages');
        if (messageContainer && messageContainer.children.length > 0) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.classList.add(messageContainer.children[0].classList.contains('alert-success') ? 'toast-success' : 'toast-error');
            toast.innerHTML = messageContainer.children[0].innerHTML;
            document.body.appendChild(toast);
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
                window.location.href = "{% url 'feature_manage' %}";
            }, 3000);
        }
    });
</script>
{% endblock %}

{% block content %}
<h1>Feature Manage</h1>

<div id="message-container">
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<form method="get">
    <label><input type="radio" name="form_action" value="category" {% if selected_action == 'category' %}checked{% endif %} title="Manage Categories"> Manage Categories</label>
    <label><input type="radio" name="form_action" value="status" {% if selected_action == 'status' %}checked{% endif %} title="Manage Statuses"> Manage Statuses</label>
    <label><input type="radio" name="form_action" value="task" {% if selected_action == 'task' %}checked{% endif %} title="Manage Tasks"> Manage Tasks</label>
    <label><input type="radio" name="form_action" value="location" {% if selected_action == 'location' %}checked{% endif %} title="Manage Locations"> Manage Locations</label>
</form>

<div id="category-form-section" class="form-section" {% if selected_action != 'category' %}style="display: none;"{% endif %}>
    <label><input type="radio" name="category_action" value="add" checked title="Add Category"> Add Category</label>
    <label><input type="radio" name="category_action" value="delete" title="Delete Category"> Delete Category</label>

    <form method="post" id="add-category-form">
        {% csrf_token %}
        <input type="hidden" name="form_action" value="category">
        <input type="hidden" name="category_action" value="add">
        <div id="add-category-section" class="category-action-section">
            <h3>Add Category</h3>
            <label for="{{ category_form.name.id_for_label }}">{{ category_form.name.label }}</label>
            {{ category_form.name }}
            <button type="submit" title="Save to add category">Save to add category</button>
        </div>
    </form>

    <form method="post" id="delete-category-form">
        {% csrf_token %}
        <input type="hidden" name="form_action" value="category">
        <input type="hidden" name="category_action" value="delete">
        <div id="delete-category-section" class="category-action-section" style="display: none;">
            <h3>Delete Category</h3>
            {% if categories_exist %}
                <label for="{{ category_form.category.id_for_label }}">{{ category_form.category.label }}</label>
                {{ category_form.category }}
                <button type="submit" title="Save to delete category">Save to delete category</button>
            {% else %}
                <p>No categories available for deletion.</p>
            {% endif %}
        </div>
    </form>
</div>

<div id="task-form-section" class="form-section" {% if selected_action != 'task' %}style="display: none;"{% endif %}>
    <form method="post" id="add-task-form">
        {% csrf_token %}
        <input type="hidden" name="form_action" value="task">
        <label><input type="radio" name="task_action" value="add" checked title="Add Task"> Add Task</label>
        <label><input type="radio" name="task_action" value="delete" title="Delete Task"> Delete Task</label>

        <div id="add-task-section" class="task-action-section">
            <h3>Add Task</h3>
            <label for="{{ task_form.task_name.id_for_label }}">{{ task_form.task_name.label }}</label>
            {{ task_form.task_name }}
            <label for="{{ task_form.description.id_for_label }}">{{ task_form.description.label }}</label>
            {{ task_form.description }}
            <label for="{{ status_task_form.status.id_for_label }}">{{ status_task_form.status.label }}</label>
            {{ status_task_form.status }}
            <label for="{{ status_task_form.is_predefined.id_for_label }}">{{ status_task_form.is_predefined.label }}</label>
            {{ status_task_form.is_predefined }}
            <div id="order-field" style="display: none;">
                <label for="{{ status_task_form.order.id_for_label }}">{{ status_task_form.order.label }}</label>
                {{ status_task_form.order }}
            </div>
            <p id="predefined-tasks-description" style="display: none;">List of predefined tasks for the selected status:</p>
            <ul id="predefined-tasks-list"></ul>
            <button type="submit" name="task_action" value="add" title="Save to add task">Save to add task</button>
        </div>
    </form>

    <form method="post" id="delete-task-form">
        {% csrf_token %}
        <input type="hidden" name="form_action" value="task">
        <div id="delete-task-section" class="task-action-section" style="display: none;">
            <h3>Delete Task</h3>
            <label for="{{ status_task_form.existing_tasks.id_for_label }}">{{ status_task_form.existing_tasks.label }}</label>
            {{ status_task_form.existing_tasks }}
            <button type="submit" name="task_action" value="delete" title="Save to delete task">Save to delete task</button>
        </div>
    </form>
</div>

<div id="status-form-section" class="form-section" {% if selected_action != 'status' %}style="display: none;"{% endif %}>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_action" value="status">
        {{ formsets.status.management_form }}
        <table>
            {% for form in formsets.status %}
                <tr>
                    <td><label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label></td>
                    <td>{{ form.name }}</td>
                    <td><label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label></td>
                    <td>{{ form.description }}</td>
                    <td><label for="{{ form.is_closed.id_for_label }}">{{ form.is_closed.label }}</label></td>
                    <td>{{ form.is_closed }}</td>
                    <td>{{ form.DELETE }}</td>
                </tr>
            {% endfor %}
        </table>
        <button type="submit" title="Save to update statuses">Save to update statuses</button>
    </form>
</div>

<div id="location-form-section" class="form-section" {% if selected_action != 'location' %}style="display: none;"{% endif %}>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_action" value="location">
        {{ formsets.location.management_form }}
        <table>
            {% for form in formsets.location %}
                <tr>
                    <td><label for="{{ form.action.id_for_label }}">{{ form.action.label }}</label></td>
                    <td>{{ form.action }}</td>
                    <td><label for="{{ form.rack_name.id_for_label }}">{{ form.rack_name.label }}</label></td>
                    <td>{{ form.rack_name }}</td>
                    <td><label for="{{ form.layer_number.id_for_label }}">{{ form.layer_number.label }}</label></td>
                    <td>{{ form.layer_number }}</td>
                    <td><label for="{{ form.num_spaces_per_layer.id_for_label }}">{{ form.num_spaces_per_layer.label }}</label></td>
                    <td>{{ form.num_spaces_per_layer }}</td>
                    <td><label for="{{ form.remove_layer_number.id_for_label }}">{{ form.remove_layer_number.label }}</label></td>
                    <td>{{ form.remove_layer_number }}</td>
                    <td><label for="{{ form.remove_rack_name.id_for_label }}">{{ form.remove_rack_name.label }}</label></td>
                    <td>{{ form.remove_rack_name }}</td>
                    <td>{{ form.DELETE }}</td>
                </tr>
            {% endfor %}
        </table>
        <button type="submit" title="Save to update locations">Save to update locations</button>
    </form>
</div>
{% endblock %}