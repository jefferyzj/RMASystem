{% extends "base.html" %}

{% block title %}Manage Categories{% endblock %}

{% block extra_head %}
<script>
    function toggleCategoryAction() {
        const selectedCategoryAction = document.querySelector('input[name="category_action"]:checked');
        if (selectedCategoryAction) {
            document.querySelectorAll('.category-action-section').forEach(section => {
                section.style.display = 'none';
            });
            const activeSection = document.getElementById(`${selectedCategoryAction.value}-category-section`);
            activeSection.style.display = 'block';
        }
    }

    function fetchCategories() {
        fetch("{% url 'manage_categories' %}", {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#categories-table tbody');
                tableBody.innerHTML = '';
                data.forEach(category => {
                    const row = document.createElement('tr');
                    const nameCell = document.createElement('td');
                    nameCell.textContent = category.name;
                    const countCell = document.createElement('td');
                    countCell.textContent = category.product_count;
                    row.appendChild(nameCell);
                    row.appendChild(countCell);
                    tableBody.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching categories:', error));
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Trigger change event on page load to set initial visibility
        toggleCategoryAction();

        // Fetch and display categories
        fetchCategories();

        // Display messages and handle redirection
        const messageContainer = document.querySelector('.messages');
        if (messageContainer && messageContainer.children.length > 0) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.classList.add(messageContainer.children[0].classList.contains('alert-success') ? 'toast-success' : 'toast-error');
            toast.innerHTML = messageContainer.children[0].innerHTML;
            document.body.appendChild(toast);
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
                window.location.href = "{% url 'manage_categories' %}";
            }, 3000);
        }

        // Add event listeners to radio buttons
        const categoryActionRadios = document.querySelectorAll('input[name="category_action"]');
        categoryActionRadios.forEach(radio => {
            radio.addEventListener('change', toggleCategoryAction);
        });
    });
</script>
{% endblock %}

{% block content %}
<h1>Manage Categories</h1>

<div id="message-container">
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div>
    <label><input type="radio" name="category_action" value="add" checked title="Add Category"> Add Category</label>
    <label><input type="radio" name="category_action" value="delete" title="Delete Category"> Delete Category</label>
</div>

<form method="post" id="add-category-form">
    {% csrf_token %}
    <input type="hidden" name="category_action" value="add">
    <div id="add-category-section" class="category-action-section">
        <h3>Add Category</h3>
        <label for="{{ category_form.name.id_for_label }}">{{ category_form.name.label }}</label>
        {{ category_form.name }}
        <button type="submit" title="Save to add category">Save to add category</button>
    </div>
</form>

<form method="post" id="delete-category-form">
    {% csrf_token %}
    <input type="hidden" name="category_action" value="delete">
    <div id="delete-category-section" class="category-action-section" style="display: none;">
        <h3>Delete Category</h3>
        {% if categories_exist %}
            <label for="{{ category_form.category.id_for_label }}">{{ category_form.category.label }}</label>
            {{ category_form.category }}
            <button type="submit" title="Save to delete category">Save to delete category</button>
        {% else %}
            <p>No categories available for deletion.</p>
        {% endif %}
    </div>
</form>

<h2>Existing Categories</h2>
<table id="categories-table">
    <thead>
        <tr>
            <th>Category Name</th>
            <th>Number of Products</th>
        </tr>
    </thead>
    <tbody>
        <!-- Categories will be dynamically populated here -->
    </tbody>
</table>

<button onclick="window.location.href='{% url 'feature_manage' %}'" title="Go back to manage other features">Go back to manage other features</button>
{% endblock %}