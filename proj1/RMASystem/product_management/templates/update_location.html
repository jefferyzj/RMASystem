{% extends "base.html" %}

{% block title %}Update Location{% endblock %}

{% block extra_head %}
<style>
    .hidden {
        display: none;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rackNameField = document.querySelector('select[name="rack_name"]');
        const layerNumberField = document.querySelector('select[name="layer_number"]');
        const spaceNumberField = document.querySelector('select[name="space_number"]');
        const searchButton = document.getElementById('search-button');
        const SNsField = document.querySelector('textarea[name="SNs"]');
        const searchResults = document.getElementById('search-results');

        if (rackNameField) {
            rackNameField.addEventListener('change', function() {
                const rackName = this.value;
                fetch(`/get_layers_for_rack/?rack_name=${rackName}`)
                    .then(response => response.json())
                    .then(data => {
                        layerNumberField.innerHTML = '<option value="" selected disabled>Select a layer</option>';
                        data.layers.forEach(layer => {
                            const option = document.createElement('option');
                            option.value = layer.layer_number;
                            option.textContent = `Layer ${layer.layer_number} - ${layer.product_count} Products`;
                            layerNumberField.appendChild(option);
                        });
                        spaceNumberField.innerHTML = '<option value="" selected disabled>Select a space</option>';
                    });
            });
        }

        if (layerNumberField) {
            layerNumberField.addEventListener('change', function() {
                const rackName = rackNameField.value;
                const layerNumber = this.value;
                fetch(`/get_empty_spaces_for_layer/?rack_name=${rackName}&layer_number=${layerNumber}`)
                    .then(response => response.json())
                    .then(data => {
                        spaceNumberField.innerHTML = '<option value="" selected disabled>Select a space</option>';
                        data.spaces.forEach(space => {
                            const option = document.createElement('option');
                            option.value = space;
                            option.textContent = space;
                            spaceNumberField.appendChild(option);
                        });
                    });
            });
        }

        if (searchButton) {
            searchButton.addEventListener('click', function() {
                const SNs = SNsField.value;
                fetch('/search_location/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ SNs })
                })
                .then(response => response.json())
                .then(data => {
                    searchResults.innerHTML = '';
                    data.results.forEach(result => {
                        const div = document.createElement('div');
                        div.textContent = `SN: ${result.SN}, Location: ${result.location}`;
                        searchResults.appendChild(div);
                    });
                });
            });
        }

        // Display messages and handle redirection
        const messageContainer = document.querySelector('.messages');
        if (messageContainer && messageContainer.children.length > 0) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.classList.add(messageContainer.children[0].classList.contains('alert-success') ? 'toast-success' : 'toast-error');
            toast.innerHTML = messageContainer.children[0].innerHTML;
            document.body.appendChild(toast);
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
            // Hide the message container
            messageContainer.classList.add('hidden');
        }
    });
</script>
{% endblock %}

{% block content %}
<h1>Update Location</h1>

<div id="message-container" class="hidden">
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<form method="post">
    {% csrf_token %}
    <div class="form-group">
        <label for="SNs">Serial Numbers (one per line)</label>
        {{ form.SNs }}
        <button type="button" id="search-button" class="btn btn-info">Search</button>
    </div>
    <div id="search-results"></div>
    <div class="form-group">
        <label for="rack_name">Rack</label>
        <select name="rack_name" id="rack_name" class="form-control">
            <option value="" selected disabled>Select a rack</option>
            {% for rack in racks %}
                <option value="{{ rack.rack_name }}">{{ rack.rack_name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="layer_number">Layer</label>
        <select name="layer_number" id="layer_number" class="form-control">
            <option value="" selected disabled>Select a layer</option>
            <!-- Options will be populated dynamically based on selected rack -->
        </select>
    </div>
    <div class="form-group">
        <label for="space_number">Space (optional)</label>
        <select name="space_number" id="space_number" class="form-control">
            <option value="" selected disabled>Select a space</option>
            <!-- Options will be populated dynamically based on selected layer -->
        </select>
    </div>
    <button type="submit" class="btn btn-primary" title="Update Location">Update Location</button>
</form>

<button onclick="window.location.href='{% url 'checkin' %}'" class="btn btn-secondary" title="Go back to Check-in">Go back to Check-in</button>
{% endblock %}